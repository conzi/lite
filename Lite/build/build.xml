<?xml version="1.0" encoding="GBK"?>
<project name="Lite" default="build" basedir="../">
	<tstamp>
		<format property="version" pattern="yyyyMMdd" />
	</tstamp>
	<available file="../JSA/build/dest/JSide.jar" property="JSAPath" value="web/WEB-INF/classes;../JSA/build/dest/JSide.jar;" />

	<target name="init">
		<delete dir="build/dest/jslite"/>
		<mkdir dir="build/dest/jslite" />
		<mkdir dir="build/dest/jslite/el" />
		<mkdir dir="build/dest/jslite/lite" />
		<mkdir dir="build/dest/jslite/lite/impl" />
		<mkdir dir="build/dest/jslite/lite/parse" />
		<mkdir dir="build/dest/jslite/lite/util" />
		<mkdir dir="build/dest" />
	</target>
	<target name="compilelite">
		<delete dir="build/dest/temp" />
		<mkdir dir="build/dest/temp" />
		<copy todir="build/dest/temp">
			<fileset dir="web">
				<include name="**/*.xhtml" />
				<include name="WEB-INF/decorators.xml" />
				<exclude name="WEB-INF/litecached/*.*" />
				<exclude name="WEB-INF/htmlcached/**/*.*" />
			</fileset>
		</copy>
		<java classname="org.xidea.lite.tools.LiteCompiler" classpath="web/WEB-INF/lib/js.jar;web/WEB-INF/lib/JSI.jar;web/WEB-INF/lib/commons-logging-1.0.4.jar;web/WEB-INF/classes">
			<arg value="-webRoot" />
			<arg value="${basedir}/build/dest/temp" />
			<arg value="-litecached" />
			<arg value="${basedir}/web/WEB-INF/litecached" />
		</java>
		<delete dir="build/dest/temp" />
	</target>

	<target name="packageOptimize">
		<java classname="org.jside.jsi.tools.web.PackageAction" classpath="${JSAPath}">
			<arg value="-scriptBase" />
			<arg value="${basedir}/web/scripts" />
			<arg value="-output" />
			<arg value="${basedir}/build/dest/package-gen.js" />

			<arg value="-packageName" />
			<arg value="org.xidea.lite" />

			<arg value="-dependences" />
			<arg value="org.xidea.jsidoc.util" />
		</java>
	</target>
	<target name="compile">
		<copy todir="web/WEB-INF/classes">
			<fileset dir="src/main">
				<include name="**/*.*" />
			</fileset>
			<fileset dir="web/scripts">
				<include name="**/*.*" />
			</fileset>
		</copy>
		<javac srcdir="web/WEB-INF/classes" fork="true" target="1.5" debug="true" destdir="web/WEB-INF/classes" encoding="UTF-8">
			<classpath>
				<fileset dir="web/WEB-INF/lib">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javac>
	</target>
	<target name="join-php">
		<concat destfile="build/dest/TemplateEngine.php" encoding="utf-8">
			<path path="src/php/lite/TemplateEngine.php" />
			<path path="src/php/lite/Template.php" />
			<path path="src/php/lite/Expression.php" />
		</concat>
		<!-- 合并之后替换掉多余的require_once  -->
		<!--
		<replaceregexp file="web/WEB-INF/template.php"
			match="^require_once|^\?&gt;&lt;\?php" replace="//\0" byline="true" encoding="utf-8"/>
		-->
		<replace file="build/dest/TemplateEngine.php" encoding="utf-8">
			<replacefilter token="&#10;require_once" value="&#10;//require_once" />
			<replacefilter token="&#10;?&gt;&lt;?php" value="&#10;//?&gt;&lt;?php" />
		</replace>
	</target>
	<target name="jar" depends="init,compress,join-php">
		<delete>
			<fileset dir="build/dest/">
				<include name="Example-*.zip" />
				<include name="Template-*.jar" />
			</fileset>
		</delete>
		<echo file="build/dest/jslite/el/__package__.js">this.setImplementation("org.xidea.lite.impl")</echo>
		<echo file="build/dest/jslite/lite/parse/__package__.js">this.setImplementation("org.xidea.lite.impl")</echo>
		<jar destfile="build/dest/Template.jar" compress="true">
			<manifest>
				<attribute name="Main-Class" value="org.xidea.lite.tools.LiteCompiler" />
			</manifest>
			<fileset dir="web/WEB-INF/classes">
				<include name="org/xidea/el/**/*.class" />
				<include name="org/xidea/lite/*.js" />
				<include name="org/xidea/lite/**/*.class" />
				<include name="org/xidea/lite/parser/impl/dtd/**/*.ent" />
				<include name="org/xidea/lite/parser/impl/dtd/**/xhtml1.dtd" />
				<exclude name="**/test/**/*.*" />
			</fileset>
			<fileset dir="src/main/" defaultexcludes="true">
				<exclude name="org/xidea/**/test/**.java" />
				<exclude name="org/xidea/**/*Test*.java" />
				<include name="org/xidea/**/*.java" />
			</fileset>
			<zipfileset prefix="org/xidea/lite/" dir="build/dest/jslite/">
				<include name="**.js" />
			</zipfileset>
			<zipfileset src="web/WEB-INF/lib/commons-logging-1.0.4.jar">
				<include name="**/*.*" />
			</zipfileset>
		</jar>
		<jar destfile="build/dest/TemplateRuntime.jar" compress="true">
			<zipfileset src="build/dest/Template.jar">
				<include name="org/xidea/**/*.*" />
				<exclude name="org/xidea/el/parser/ExpressionTokenizer.*" />
				<exclude name="org/xidea/el/parser/ExpressionTokenizer$*" />
				<exclude name="**/*.java" />
				<exclude name="**/*.js" />
				<exclude name="org/xidea/lite/servlet/*.*" />
				<exclude name="org/xidea/lite/tools/*.*" />
				<exclude name="org/xidea/lite/parser/**/*.*" />
			</zipfileset>
		</jar>
		<delete file="build/dest/jslite/__package__.js" />
		<copy tofile="build/dest/Template-${version}.jar" file="build/dest/Template.jar" />
		<copy tofile="build/dest/TemplateRuntime-${version}.jar" file="build/dest/TemplateRuntime.jar" />

		<zip destfile="build/dest/Example.zip">
			<zipfileset dir="build/dest/" prefix="WEB-INF/lib/">
				<include name="Template.jar" />
			</zipfileset>
			<zipfileset dir="build/dest/" prefix="WEB-INF/classes/lite/">
				<include name="TemplateEngine.php" />
			</zipfileset>
			<zipfileset dir="web/">
				<include name="WEB-INF/classes/lite/*.py" />
				<include name="WEB-INF/lib/commons-logging-1.0.4.jar" />
				<include name="WEB-INF/decorators.xml" />
				<include name="WEB-INF/web.xml" />
				<include name="example/*.xhtml" />
				<include name="example/test.php" />
				<include name="example/test.py" />
			</zipfileset>
		</zip>
		<copy tofile="build/dest/Example-${version}.zip" file="build/dest/Example.zip" />

	</target>
	<target name="test">

		<java failonerror="true" classname="org.jside.jsi.tools.export.ExportAction" classpath="${JSAPath}">
			<arg value="-scriptBase" />
			<arg value="${basedir}/web/scripts" />
			<arg value="-config.ascii" />
			<arg value="false" />
			<arg value="-config.features" />
			<arg value="org.xidea.lite:Compile" />
			<arg value="org.xidea.jsi.boot:$log" />

			<arg value="-exports" />
			<arg value="org.xidea.el:*" />
			<arg value="org.xidea.lite:*" />
			<arg value="org.xidea.lite.impl:*" />
			<arg value="org.xidea.lite.parse:*" />

			<arg value="-outputExported" />
			<arg value="${basedir}/build/dest/jslite/template.js" />
		</java>
	</target>

	<target name="compress" depends="init">
		<echo>压缩JSLite实现</echo>

		<!-- export lite -->
		<!-- empty -->
		<!-- export lite impl,parse,el -->
		<java failonerror="true" classname="org.jside.jsi.tools.export.ExportAction" classpath="${JSAPath}">
			<arg value="-scriptBase" />
			<arg value="${basedir}/web/scripts" />
			<arg value="-exports" />
			<arg value="org.xidea.el:*" />
			<arg value="org.xidea.lite.impl:*" />
			<arg value="org.xidea.lite.parse:*" />
			<!--
			<arg value="-bootCached"/>
			<arg value="org.xidea.lite.util:*" />
			<arg value="org.xidea.jsi:*" />
			-->
			<arg value="-outputPackage" />
			<arg value="${basedir}/build/dest/jslite/lite/impl/__package__.js" />
			<arg value="-outputExported" />
			<arg value="${basedir}/build/dest/jslite/lite/impl/impl.js" />
		</java>

		<!-- export lite uril -->
		<java failonerror="true" classname="org.jside.jsi.tools.export.ExportAction" classpath="${JSAPath}">
			<arg value="-scriptBase" />
			<arg value="${basedir}/web/scripts" />
			<arg value="-exports" />
			<arg value="org.xidea.lite.util:*" />
			<!--
			<arg value="-bootCached"/>
			<arg value="org.xidea.lite.util:*" />
			-->
			<arg value="-outputPackage" />
			<arg value="${basedir}/build/dest/jslite/lite/util/__package__.js" />
			<arg value="-outputExported" />
			<arg value="${basedir}/build/dest/jslite/lite/util/impl.js" />
		</java>
		
		<echo>压缩JS在线演示实现</echo>
		<java classname="org.jside.jsi.tools.export.ExportAction" classpath="${JSAPath}">
			<arg value="-scriptBase" />
			<arg value="${basedir}/web/scripts" />
			<arg value="-config.features" />
			<arg value=":Debug" />
			<arg value="-exports" />
			<arg value="org.xidea.lite.web.demo:TestCase" />

			<arg value="-outputExported" />
			<arg value="${basedir}/build/dest/jslite/demo.js" />
		</java>
	</target>
	<target name="build" depends="compress,jar,php-example">

	</target>

	<target name="php-example">
		<zip comment="批量编译:java -jar ./WEB-INF/lib/Template.jar -root ." file="build/dest/php-example.zip" encoding="GBK">
			<fileset dir="web">
				<include name="example/test.php" />
				<include name="example/test.xhtml" />
				<include name="example/layout.xhtml" />
				<include name="WEB-INF/decorators.xml" />
			</fileset>
			<zipfileset dir="build/dest/" prefix="WEB-INF/classes/lite/">
				<include name="TemplateEngine.php" />
			</zipfileset>
			<zipfileset dir="build/dest/" prefix="WEB-INF/lib">
				<include name="Template.jar" />
			</zipfileset>
		</zip>
	</target>

	<target name="static">
		<java classname="org.xidea.lite.tools.LiteCompiler" classpath="web/WEB-INF/classes;web/WEB-INF/lib/commons-logging-1.0.4.jar;web/WEB-INF/lib/js.jar;web/WEB-INF/lib/JSI.jar">
			<arg value="-webRoot" />
			<arg value="${basedir}/web/" />

			<arg value="-htmlcached" />
			<arg value="${basedir}/web/WEB-INF/htmlcached" />

		</java>
	</target>
</project>