<html xmlns:x="http://www.xidea.org/lite/example" xmlns="http://www.w3.org/1999/xhtml"
	xml:lang="zh-CN" dir="ltr">
	<head>
		<title>模板编译扩展</title>
	</head>
	<body>
		<h3>功能支持</h3>
		<p>
			Lite 是一个模板平台，而不仅仅是一个模板系统，我们可以在这个平台上自己设计模板语法。

			在现有基础上，我们可以通过如下三种形式扩展模板语法。
			<ul>
				<li>扩展名称空间标签语法。</li>
				<li>扩展名称空间属性语法。</li>
				<li>扩展文本语法。</li>
			</ul>

			本文，我们将重点介绍标签语法的扩展方法。
		</p>
		<h3>API结构</h3>
		<p>Lite 一共有9中中间代码，一个通用的结束指令，一个批量条件接口，一个静态文本添加接口，共有12个中间指令操作接口。
			他们分别是：
			<ul>
				<li>append(text)
					<p>
						用于添加静态文本。例如：
						<x:code>
						<![CDATA[
							<c:extenson package="http://www.w3.org/1999/xhtml">
								//我需要一个插件，让所有a标签都加上一个中括弧([]),实现代码如下。
								parseA(node){
									this.append('[');
									//让下一个解析器实现最终解析
									this.next(node);
									this.append(']');
									
								}
							</c:extenson>
						]]>
						</x:code>
					</p></li>
				<li>appendEL(el)
					<p>用于添加一段表达式输出（不编码）
						
					</p></li>
				<li>appendIf(el)
					<p>用于开始一个条件判断（结束用appendEnd()）
					<x:code>
					<![CDATA[
						function parseIf(node){
							var el = node.getAttribute('test');
							el = el.replace(/^\$\{([\s\S]+)\}$/,'$1');
							this.appendIf(el);
							this.parse(el.childNodes);
							this.appendEnd();
						}
					]]>
					</x:code>
					</p>
				</li>
				<li>appendElse(el)
					<p>用于开始一个条件判断（结束用appendEnd()）</p></li>
				<li>appendEnd()<p>通用的结束符（用于结束一个if语法，for循环，plugin等等...）</p></li>
				<li>appendFor(varName, el, status)<p>开始一个for循环</p></li>
				<li>appendXA(attrName, el)<p>添加一个XML 属性，当attrName 为空时，只做属性编码输出，不做属性语法输出（输出判断+属性名=".."）。</p></li>
				<li>appendXT(el)<p>添加一个XML文本输出</p></li>
				<li>appendVar(varName, el)<p>申明一个模板变量</p></li>
				<li>appendCapture(varName)<p>捕捉一段输出，将结果申明为指定变量名</p></li>
				<li>appendPlugin(pluginClass, pluginConfig)<p>添加插件</p></li>
				<li>appendAll(list)<p>将一组中间代码，批量添加进来。</p></li>
			</ul>
		</p>
		<p></p>
		<h3>示例1</h3>
		<ul>
			<p>有没有为javascript多行字符串申明苦恼过？我们可以写一个模板扩展，让这个事情顺利一点。</p>
			<x:code model="{}">
			<![CDATA[
			<html xmlns:x="http://www.xidea.org/lite/example">
			<head>
			<title>==测试==</title>
			<c:extension namespace="http://www.xidea.org/lite/example">
				<![CDATA[
				function parseString(node){
					var text = String(node.textContent || node.text);
					text = text.replace(/^\s*[\r\n]+|[\r\n]+\s*$/g,'');
					var varName = node.getAttribute('var');
					this.append("<script>var "
						+varName+'='+JSON.stringify(text)
						+";<\/script>");
				}
				]]>]]<![CDATA[>
			</c:extension>
			</head>
			<body>
				<x:string var="source">
				<![CDATA[
				<html>
				<body>
					随便写点什么
				</body>
				</html>
				]]>]]<![CDATA[>
				</x:string>
			</body>
			</html>
			]]>
			</x:code>
		</ul>
		<h3>示例2</h3>
		<ul>
			<p>有时候，我们需要吧一些有换行的文本显示成换行，但是，有希望代码是编码安全的。通常，这种功能只能通过内置函数实现。
			现在，我们尝试用一个插件解决这个问题。
			</p>
			<x:code model="{text:'abc\ndef\nghi\n<script>该编码的还是的编码<\/script>'}">
			<![CDATA[
			<html xmlns:x="http://www.xidea.org/lite/example">
			<head>
			<title>==测试==</title>
			<c:extension namespace="http://www.xidea.org/lite/example">
				<![CDATA[
				function parseNL2BR(node){
					var text = String(node.textContent || node.text);
					var varId = this.allocateId();
					//生成内容
					this.appendCapture(varId)
					//以不编码的方式捕捉内容
					var list = this.parseText(text,0);
					this.appendAll(list);
					this.appendEnd();
					
					//将生成内容按行劈成数组，循环安全输出
					var forId = this.allocateId();
					this.appendFor(forId,varId+".split('\\n')",null);
					this.appendXT(forId);
					this.append("<br/>");
					this.appendEnd();
				}
				]]>]]<![CDATA[>
			</c:extension>
			</head>
			<body>
				<x:nl2br>随便写点什么，
				变量也行${text}
				</x:nl2br>
			</body>
			</html>
			]]>
			</x:code>
		</ul>
		<h3>真实运用示例</h3>
		<ul>
			<p>该文档系统中，有个常用的模板语法扩展:代码着色语法，该语法的书写形式如：。</p>
			<x:code><![CDATA[
			<!-- modelVar 属性用来指定一个模板数据模型，如果存在，她会生成一个运行按钮 -->
			<x:code model="modelVar"><![CDATA[
				...这里你可以任意书写源码了,系统会自动作色...
			]]>]]&gt;&lt;/x:code>
			</x:code>
			<p>这个插件的实现在吗在layout.xhtml 中。片段如下。</p>
			<x:code>
				<![CDATA[
<c:extension namespace="http://www.xidea.org/lite/example">
	<![CDATA[
		var style = 'border: 1px solid #DFECF1;'
    			+'font-family:"Courier New",monospace;'
    			+'padding:4px;margin:4px;'
    			+'font-size:12px;overflow:auto;'
    			+'background-color:#EEE;border:1px solid #222;';
		//代码高亮标签解析器
		function parseCode(node){
			var text = String(node.textContent || node.text);
			//清理相同的前置缩进
			text = text.replace(/^\s*[\r\n]+|[\r\n]+\s*$/g,'');
			while(/^(?:[\t ].*[\r\n]*)*$/.test(text)){
				text = text.replace(/^[\t ](.*)/mg,'$1');
			}
			text = JSON.stringify(text);
			//用于申明多行字符串
			var varName = node.getAttribute("var");
			if(varName){
				this.append("<script>" + varName+'=' +text+";<\/script>")
			}else{
				var model = node.getAttribute("model");
				if(model){
					if(/^\s*\{$/.test(model)){
						model = JSON.stringify(text)
					}
					model = ','+model+'';
				}
				this.append("<div class='code'><script>renderSource("+text+model+");<\/script></div>")
			}
		};
]]>	]]&gt;
&lt;/c:extension>
			</x:code>
		</ul>
	</body>
</html>
